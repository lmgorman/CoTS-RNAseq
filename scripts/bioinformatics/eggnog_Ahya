#Script for running eggnog mapper on Ahya genome
#taking place in scratch directory


#!/bin/bash
#SBATCH --job-name=annot-Ahya-eggnog
#SBATCH --nodes=1
#SBATCH --cpus-per-task=10
#SBATCH --mem=300G
#SBATCH -p cpu
#SBATCH --time=48:00:00
#SBATCH --constraint=avx512
#SBATCH -o annot-Ahya-eggnog-%j.out
#SBATCH -e annot-Ahya-eggnog-%j.error
#SBATCH -D /data/gorman/project/raw-files

# Load modules
echo "Loading modules" $(date)
module purge
module load uri/main
module load all/eggnog-mapper/2.1.9-foss-2022a

# Set up scratch directory
SCRATCHDIR=/scratch/${USER}_${SLURM_JOB_ID}
mkdir -p "$SCRATCHDIR"
echo "Scratch directory created at $SCRATCHDIR"

# Define input and output
INPUT=/work/pi_hputnam_uri_edu/refs/Ahyacinthus_genome/Ahyacinthus_genome_V1/Ahyacinthus.proteins.fasta
OUTPUT_BASENAME=ahya_eggnog
FINAL_OUTPUT_DIR=/work/pi_hputnam_uri_edu/ashuffmyer/cots-gorman/Ahya_ann/eggnog

# Copy input file to scratch
cp "$INPUT" "$SCRATCHDIR/"
cd "$SCRATCHDIR"

# Run eggnog-mapper
echo "Running eggnog-mapper on $(hostname) at $(date)"
emapper.py \
  -i $(basename "$INPUT") \
  -o "$OUTPUT_BASENAME" \
  --cpu 10

# Copy results back
echo "Copying results back to $FINAL_OUTPUT_DIR"
mkdir -p "$FINAL_OUTPUT_DIR"
cp "${OUTPUT_BASENAME}"* "$FINAL_OUTPUT_DIR/"

# Cleanup (optional)
echo "Cleaning up scratch"
rm -rf "$SCRATCHDIR"

echo "Job complete at $(date)"
